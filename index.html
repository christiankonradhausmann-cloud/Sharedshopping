<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shared Shopping</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
      max-width: 500px;
      margin: auto;
      padding: 1rem;
    }
    h1 { text-align: center; }
    ul { list-style: none; padding: 0; }
    li {
      background: #fff;
      margin: 0.5rem 0;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    input[type="text"] {
      padding: 0.4rem;
    }
    .input-name {
      flex: 2;
      margin-right: 0.5rem;
    }
    .input-qty {
      flex: 1;
      margin-right: 0.5rem;
    }
    button {
      border: none;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      border-radius: 4px;
      color: white;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-left: 6px;
    }
    .btn-add { background: #2ecc71; }
    .btn-del { background: #e74c3c; }
    .btn-voice { background: #3498db; transition: background 0.3s; }
    .btn-voice.saved { background: #27ae60; }
    .btn-play { background: #9b59b6; }
    .btn-play.has-audio { background: #2ecc71; position: relative; }
    .btn-play.has-audio::after {
      content: "âœ”";
      font-size: 0.8em;
      animation: pop 0.4s ease-out;
    }
    @keyframes pop {
      0% { transform: scale(0); opacity: 0; }
      60% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); }
    }
    .visualizer {
      width: 40px;
      height: 20px;
      margin-right: 6px;
    }
    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .controls {
      display: flex;
      align-items: center;
    }
    .editable {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Shared Shopping ðŸ›’</h1>

  <div style="display:flex; margin-bottom:1rem;">
    <input id="itemName" class="input-name" type="text" placeholder="Artikel..." />
    <input id="itemQty" class="input-qty" type="text" placeholder="Menge..." />
    <button id="addBtn" class="btn-add disabled">âž•</button>
  </div>

  <ul id="list"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBapD5LES4TOhhHjgX3664a7DnxC2043JU",
      authDomain: "shoppinglist-66fa7.firebaseapp.com",
      projectId: "shoppinglist-66fa7",
      storageBucket: "shoppinglist-66fa7.firebasestorage.app",
      messagingSenderId: "531815588287",
      appId: "1:531815588287:web:28e9cac4f6de909361c10a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let authReady = false;
    const addBtn = document.getElementById("addBtn");
    const listEl = document.getElementById("list");
    const nameInput = document.getElementById("itemName");
    const qtyInput = document.getElementById("itemQty");

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authReady = true;
        addBtn.classList.remove("disabled");
      } else {
        signInAnonymously(auth).catch(e => {
          alert("Auth-Fehler: " + e.message);
        });
      }
    });

    addBtn.onclick = async () => {
      if (!authReady) {
        alert("Warte auf Anmeldung...");
        return;
      }
      const name = nameInput.value.trim();
      const qty = qtyInput.value.trim();
      if (!name) return;
      await addDoc(collection(db, "items"), { name, quantity: qty || "" });
      nameInput.value = "";
      qtyInput.value = "";
    };

    function makeEditable(span, field, docRef) {
      span.onclick = () => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = span.textContent;
        span.replaceWith(input);
        input.focus();
        input.onblur = async () => {
          const newValue = input.value.trim();
          await updateDoc(docRef, { [field]: newValue });
          span.textContent = newValue;
          input.replaceWith(span);
        };
        input.onkeydown = (e) => {
          if (e.key === "Enter") input.blur();
        };
      };
    }

    onSnapshot(collection(db, "items"), (snapshot) => {
      listEl.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const docRef = doc(db, "items", docSnap.id);
        const li = document.createElement("li");

        const infoDiv = document.createElement("div");
        infoDiv.style.display = "flex";
        infoDiv.style.flexDirection = "column";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = data.name || "";
        nameSpan.classList.add("editable");
        makeEditable(nameSpan, "name", docRef);

        const qtySpan = document.createElement("span");
        qtySpan.textContent = data.quantity || "";
        qtySpan.classList.add("editable");
        makeEditable(qtySpan, "quantity", docRef);

        infoDiv.appendChild(nameSpan);
        infoDiv.appendChild(qtySpan);
        li.appendChild(infoDiv);

        const controls = document.createElement("div");
        controls.className = "controls";

        const canvas = document.createElement("canvas");
        canvas.className = "visualizer";
        const ctx = canvas.getContext("2d");
        controls.appendChild(canvas);

        const voiceBtn = document.createElement("button");
        voiceBtn.textContent = "ðŸŽ™";
        voiceBtn.className = "btn-voice disabled";
        controls.appendChild(voiceBtn);

        const playBtn = document.createElement("button");
        playBtn.textContent = "ðŸ”Š";
        playBtn.className = "btn-play";
        if (data.voiceUrl) {
          playBtn.classList.add("has-audio");
        }
        playBtn.onclick = () => {
          if (data.voiceUrl) {
            const audio = new Audio(data.voiceUrl);
            audio.play();
          } else {
            alert("Keine Sprachnotiz vorhanden.");
          }
        };
        controls.appendChild(playBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "ðŸ—‘";
        delBtn.className = "btn-del";
        delBtn.onclick = () => deleteDoc(docRef);
        controls.appendChild(delBtn);

        li.appendChild(controls);
        listEl.appendChild(li);

        if (authReady) voiceBtn.classList.remove("disabled");

        let mediaRecorder = null;
        let chunks = [];
        let animationId = null;
        let audioContext, analyser, dataArray, source;

        voiceBtn.onclick = async () => {
          if (!authReady) {
            alert("Warte auf Anmeldung...");
            return;
          }
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            cancelAnimationFrame(animationId);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            return;
          }
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            chunks = [];
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
            mediaRecorder.onstop = async () => {
              stream.getTracks().forEach(t => t.stop());
              const blob = new Blob(chunks, { type: chunks[0].type });
              const ext = blob.type.includes("webm") ? "webm" : "m4a";
              const objectRef = ref(storage, `voiceNotes/${docSnap.id}.${ext}`);
              await uploadBytes(objectRef, blob, { contentType: blob.type });
              const url = await getDownloadURL(objectRef);
              await updateDoc(docRef, { voiceUrl: url });

              voiceBtn.classList.add("saved");
              setTimeout(() => voiceBtn.classList.remove("saved"), 1000);

              playBtn.classList.remove("has-audio");
              void playBtn.offsetWidth;
              playBtn.classList.add("has-audio");
            };
            mediaRecorder.start();

            audioContext = new AudioContext();
            analyser = audioContext.createAnalyser();
            source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            function draw() {
              animationId = requestAnimationFrame(draw);
              analyser.getByteFrequencyData(dataArray);
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = "#3498db";
              const barHeight = Math.max(...dataArray) / 2;
              ctx.fillRect(0, canvas.height - barHeight, canvas.width, barHeight);
            }
            draw();

          } catch (err) {
            alert("Mikrofon nicht verfÃ¼gbar: " + err.message);
          }
        };
      });
    });
  </script>
</body>
</html>
