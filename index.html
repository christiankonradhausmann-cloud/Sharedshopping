<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shared Shopping</title>
  <style>
    :root{
      --green:#2ecc71;--red:#e74c3c;--blue:#3498db;--purple:#9b59b6;
      --bg:#f7f7f7;--card:#fff;--muted:#555
    }
    body{
      font-family:system-ui, sans-serif;background:var(--bg);
      max-width:500px;margin:auto;padding:1rem
    }
    h1{text-align:center;margin:.2rem 0 1rem}

    /* ===== Passwort-Gate (Overlay) ===== */
    #authGate {
      position: fixed; inset: 0; background: rgba(247,247,247,.98);
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    }
    #authCard {
      background: #fff; border:1px solid #ddd; border-radius: 10px;
      width: min(420px, 92vw); padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.08);
      font-family: system-ui, sans-serif;
    }
    #authCard h2 { margin: 0 0 8px; }
    #authCard input { width: 100%; padding: 10px; border:1px solid #ddd; border-radius: 8px; }
    #rememberRow { display:flex; align-items:center; gap:8px; margin-top:8px; }
    #authRow { display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; }
    #authBtn { background:#2ecc71; color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; }
    #authError { color:#e74c3c; font-size:.9rem; display:none; margin-top:8px; }

    /* ===== Eingabezeile ===== */
    .add-row{display:flex;align-items:center;margin-bottom:.75rem;gap:.5rem}
    .input-qty, .input-name{
      border:1px solid #ddd;border-radius:6px;padding:.35rem .4rem;
      font-size:.9rem;min-width:3ch;width:auto;box-sizing:content-box;
    }
    .btn-add{flex:0 0 auto}

    button{
      border:none;border-radius:6px;color:#fff;cursor:pointer;
      padding:.35rem .4rem;display:flex;align-items:center;gap:4px;
      font-size:.9rem
    }
    .btn-add{background:var(--green)}
    .btn-del{background:var(--red)}
    .btn-voice{background:var(--blue);transition:background .3s}
    .btn-voice.saved{background:#27ae60}
    .btn-play{background:var(--purple)}
    .btn-play.has-audio{background:var(--green);position:relative}
    .btn-play.has-audio::after{content:"âœ”";font-size:.8em;animation:pop .4s ease-out}
    @keyframes pop{0%{transform:scale(0);opacity:0}60%{transform:scale(1.2);opacity:1}100%{transform:scale(1)}}
    .disabled{opacity:.5;pointer-events:none}

    /* ===== Liste ===== */
    ul{list-style:none;padding:0;margin:0}
    li{
      background:var(--card);border:1px solid #ddd;border-radius:6px;
      padding:.35rem .4rem;margin:.3rem 0;
      display:grid;grid-template-columns:auto 1fr auto;gap:.5rem;align-items:center
    }
    .item-left{
      display:flex;align-items:center;gap:.5rem;min-width:0;
    }
    .cb-small{width:16px;height:16px}
    .text-block{display:flex;flex-direction:column;min-width:0}
    .qty{font-size:.8em;color:var(--muted)}
    .name{white-space:normal;word-break:break-word}
    .editable{cursor:pointer}

    /* Rechte Button-Gruppe */
    .controls{
      display:flex;align-items:center;gap:.3rem;justify-content:flex-end;
      flex-wrap:nowrap
    }
    .controls button{padding:.3rem .35rem;font-size:.85rem}
    .visualizer{width:24px;height:14px}

    /* ===== Bulk-Bar ===== */
    .bulk-bar{
      display:flex;justify-content:space-between;align-items:center;
      margin-top:.75rem;flex-wrap:wrap;gap:.5rem
    }
    .bulk-bar > div {
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .btn-secondary{background:#444}
    .btn-muted{background:#bbb;color:#222}
    .hint{color:#777;font-size:.9rem}
  </style>
</head>
<body>
  <h1>SharedShopping ðŸ›’ðŸ¦™</h1>

  <!-- Passwort-Gate -->
  <div id="authGate">
    <div id="authCard">
      <h2>ðŸ”’ Zugang</h2>
      <p>Bitte Passwort eingeben, um die Liste zu Ã¶ffnen.</p>
      <input id="pwInput" type="password" placeholder="Passwort" autocomplete="current-password" />
      <div id="rememberRow">
        <label><input id="rememberDevice" type="checkbox"> auf diesem GerÃ¤t merken</label>
      </div>
      <div id="authRow">
        <button id="authBtn">Entsperren</button>
      </div>
      <div id="authError">Falsches Passwort.</div>
    </div>
  </div>

  <!-- Eingabe -->
  <div class="add-row">
    <input id="itemQty" class="input-qty" type="text" placeholder="Menge" />
    <input id="itemName" class="input-name" type="text" placeholder="Artikel" />
    <button id="addBtn" class="btn-add disabled">âž•</button>
  </div>

  <ul id="list"></ul>

  <!-- Bulk Actions -->
  <div class="bulk-bar">
    <div>
      <button id="toggleAllBtn" class="btn-secondary">Alle auswÃ¤hlen</button>
      <span id="selectionHint" class="hint">0 ausgewÃ¤hlt</span>
    </div>
    <div>
      <button id="undoBtn" class="btn-secondary" style="display:none;">â†© RÃ¼ckgÃ¤ngig</button>
      <button id="deleteSelectedBtn" class="btn-del btn-muted" disabled>AuswahllÃ¶schen</button>
    </div>
  </div>

  <!-- App-Logik -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, getDocs, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBapD5LES4TOhhHjgX3664a7DnxC2043JU",
      authDomain: "shoppinglist-66fa7.firebaseapp.com",
      projectId: "shoppinglist-66fa7",
      storageBucket: "shoppinglist-66fa7.firebasestorage.app",
      messagingSenderId: "531815588287",
      appId: "1:531815588287:web:28e9cac4f6de909361c10a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    const qtyInput = document.getElementById("itemQty");
    const nameInput = document.getElementById("itemName");
    const addBtn = document.getElementById("addBtn");
    const listEl = document.getElementById("list");
    const toggleAllBtn = document.getElementById("toggleAllBtn");
    const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
    const undoBtn = document.getElementById("undoBtn");
    const selectionHint = document.getElementById("selectionHint");

    const selectedIds = new Set();
    let lastDeletedItems = [];

    /* ===== Passwort-Gate Logik ===== */
    const PASSWORD_SHA256_HEX = "8cbbcf29d9cef89675c5f5c1dcfe827d0570416a5aaba30dd0de159661ad905b";
    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    const gate = document.getElementById("authGate");
    const authBtn = document.getElementById("authBtn");
    const pwInput = document.getElementById("pwInput");
    const authErr = document.getElementById("authError");
    const remember = document.getElementById("rememberDevice");
    if (localStorage.getItem("sharedShoppingUnlocked") === "yes") gate.style.display = "none";
    authBtn.onclick = async () => {
      authErr.style.display = "none";
      const hash = await sha256Hex(pwInput.value || "");
      if (hash === PASSWORD_SHA256_HEX){
        if (remember.checked) localStorage.setItem("sharedShoppingUnlocked","yes");
        gate.style.display = "none";
      } else {
        authErr.style.display = "block";
        pwInput.select();
      }
    };
    pwInput.addEventListener("keydown", e => { if (e.key === "Enter") authBtn.click(); });

    /* ===== Auto-Breite fÃ¼r Eingabefelder ===== */
    function autoResizeInput(el, placeholder) {
      const testSpan = document.createElement("span");
      testSpan.style.visibility = "hidden";
      testSpan.style.whiteSpace = "pre";
      document.body.appendChild(testSpan);
      function resize() {
        testSpan.textContent = el.value || placeholder;
        el.style.width = testSpan.offsetWidth + 12 + "px";
      }
      el.addEventListener("input", resize); resize();
    }
    autoResizeInput(qtyInput, "Menge");
    autoResizeInput(nameInput, "Artikel");

    /* ===== Auth (anonym) ===== */
    let authReady = false;
    onAuthStateChanged(auth, (user) => {
      if (user) { authReady = true; addBtn.classList.remove("disabled"); }
      else { signInAnonymously(auth).catch(e => alert("Auth-Fehler: " + e.message)); }
    });

    /* ===== HinzufÃ¼gen ===== */
    addBtn.onclick = async () => {
      if (!authReady) { alert("Warte auf Anmeldung..."); return; }
      const name = nameInput.value.trim();
      const qty = qtyInput.value.trim();
      if (!name) return;
      await addDoc(collection(db, "items"), { name, quantity: qty || "" });
      nameInput.value = ""; qtyInput.value = "";
      nameInput.dispatchEvent(new Event("input"));
      qtyInput.dispatchEvent(new Event("input"));
    };

    /* ===== Inline-Edit ===== */
    function makeEditable(span, field, docRef){
      span.onclick = () => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = span.textContent;
        input.style.width = Math.max(4, span.textContent.length + 2) + "ch";
        span.replaceWith(input);
        input.focus();
        input.onblur = async () => {
          const newVal = input.value.trim();
          await updateDoc(docRef, { [field]: newVal });
          span.textContent = newVal;
          input.replaceWith(span);
        };
        input.onkeydown = (e) => { if (e.key === "Enter") input.blur(); };
      };
    }

    /* ===== Render + Audio ===== */
    onSnapshot(collection(db, "items"), (snapshot) => {
      const currentIds = new Set();
      listEl.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const id = docSnap.id; currentIds.add(id);
        const data = docSnap.data();
        const docRef = doc(db, "items", id);

        const li = document.createElement("li");

        const cb = document.createElement("input");
        cb.type = "checkbox"; cb.className = "cb-small";
        cb.checked = selectedIds.has(id);
        cb.onchange = () => { if (cb.checked) selectedIds.add(id); else selectedIds.delete(id); updateSelectionUI(); };
        li.appendChild(cb);

        const textBlock = document.createElement("div");
        textBlock.className = "text-block";
        const qtySpan = document.createElement("span");
        qtySpan.className = "qty editable";
        qtySpan.textContent = data.quantity || "";
        makeEditable(qtySpan, "quantity", docRef);
        const nameSpan = document.createElement("span");
        nameSpan.className = "name editable";
        nameSpan.textContent = data.name || "";
        makeEditable(nameSpan, "name", docRef);
        textBlock.appendChild(qtySpan);
        textBlock.appendChild(nameSpan);
        li.appendChild(textBlock);

        const controls = document.createElement("div");
        controls.className = "controls";
        const canvas = document.createElement("canvas");
        canvas.className = "visualizer";
        const ctx = canvas.getContext("2d");
        controls.appendChild(canvas);
        const voiceBtn = document.createElement("button");
        voiceBtn.textContent = "ðŸŽ™";
        voiceBtn.className = "btn-voice" + (authReady ? "" : " disabled");
        controls.appendChild(voiceBtn);
        const playBtn = document.createElement("button");
        playBtn.textContent = "ðŸ”Š";
        playBtn.className = "btn-play";
        if (data.voiceUrl) playBtn.classList.add("has-audio");
        playBtn.onclick = () => { if (data.voiceUrl) new Audio(data.voiceUrl).play(); else alert("Keine Sprachnotiz vorhanden."); };
        controls.appendChild(playBtn);
        const delBtn = document.createElement("button");
        delBtn.textContent = "ðŸ—‘";
        delBtn.className = "btn-del";
        delBtn.onclick = () => deleteDoc(docRef);
        controls.appendChild(delBtn);
        li.appendChild(controls);
        listEl.appendChild(li);

        let mediaRecorder = null, chunks = [], animationId = null, audioContext, analyser, source, dataArray;
        voiceBtn.onclick = async () => {
          if (!authReady) { alert("Warte auf Anmeldung..."); return; }
          if (mediaRecorder && mediaRecorder.state === "recording"){
            mediaRecorder.stop(); cancelAnimationFrame(animationId); ctx.clearRect(0,0,canvas.width,canvas.height); return;
          }
          try{
            const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
            chunks = []; mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
            mediaRecorder.onstop = async () => {
              stream.getTracks().forEach(t=>t.stop());
              const blob = new Blob(chunks, { type: chunks[0].type });
              const ext = blob.type.includes("webm") ? "webm" : "m4a";
              const objectRef = ref(storage, `voiceNotes/${id}.${ext}`);
              await uploadBytes(objectRef, blob, { contentType: blob.type || "audio/mp4" });
              const url = await getDownloadURL(objectRef);
              await updateDoc(docRef, { voiceUrl: url });
              voiceBtn.classList.add("saved"); setTimeout(()=>voiceBtn.classList.remove("saved"), 1000);
              playBtn.classList.remove("has-audio"); void playBtn.offsetWidth; playBtn.classList.add("has-audio");
            };
            mediaRecorder.start();
            audioContext = new AudioContext(); analyser = audioContext.createAnalyser();
            source = audioContext.createMediaStreamSource(stream); source.connect(analyser);
            analyser.fftSize = 256; dataArray = new Uint8Array(analyser.frequencyBinCount);
            const draw = () => { animationId = requestAnimationFrame(draw);
              analyser.getByteFrequencyData(dataArray); ctx.clearRect(0,0,canvas.width,canvas.height);
              ctx.fillStyle = "#3498db"; const barH = Math.max(...dataArray)/2;
              ctx.fillRect(0, canvas.height - barH, canvas.width, barH);
            }; draw();
          }catch(err){ alert("Mikrofon nicht verfÃ¼gbar: " + err.message); }
        };
      });
      [...selectedIds].forEach(id => { if (!currentIds.has(id)) selectedIds.delete(id); });
      updateSelectionUI();
    });

    /* ===== Bulk-Actions ===== */
    deleteSelectedBtn.onclick = async () => {
      if (selectedIds.size === 0) return;
      if (!confirm(`${selectedIds.size} ausgewÃ¤hlte EintrÃ¤ge lÃ¶schen?`)) return;
      lastDeletedItems = [];
      const snap = await getDocs(collection(db, "items"));
      const toDelete = [];
      snap.forEach(d => { if (selectedIds.has(d.id)){ lastDeletedItems.push({ id: d.id, ...d.data() }); toDelete.push(d.id); } });
      if (toDelete.length === 0) return;
      const batch = writeBatch(db); toDelete.forEach(id => batch.delete(doc(db,"items",id)));
      await batch.commit(); selectedIds.clear(); updateSelectionUI();
      if (lastDeletedItems.length > 0) document.getElementById("undoBtn").style.display = "inline
