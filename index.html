<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shared Shopping</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f4f4;
  }
  header {
    background: #4CAF50;
    color: white;
    padding: 1rem;
    text-align: center;
    font-size: 1.5rem;
  }
  main {
    padding: 1rem;
    max-width: 600px;
    margin: auto;
  }
  .input-row {
    display: flex;
    gap: .5rem;
    margin-bottom: 1rem;
    align-items: center;
  }
  input {
    padding: .5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .btn {
    padding: .5rem .75rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-add { background: #4CAF50; color: white; }
  .btn-del { background: #e74c3c; color: white; }
  .btn-secondary { background: #444; color: white; }
  .btn-muted { background: #bbb; color: #222; }
  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  li {
    background: white;
    padding: .5rem;
    border-radius: 4px;
    margin-bottom: .5rem;
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: .5rem;
  }
  .item-text {
    display: flex;
    flex-direction: column;
  }
  .bulk-bar {
    display: flex;
    justify-content: space-between;
    align-items: center; /* Buttons und Text b√ºndig */
    margin-top: .75rem;
    flex-wrap: wrap;
    gap: .5rem;
  }
  .bulk-left, .bulk-right {
    display: flex;
    align-items: center;
    gap: .5rem;
  }
  .hint { color: #777; font-size: .9rem; }
  /* Auth Overlay */
  #authGate {
    position: fixed; inset: 0; background: rgba(247,247,247,.98);
    display: flex; align-items: center; justify-content: center; z-index: 9999;
  }
  #authCard {
    background: #fff; border: 1px solid #ddd; border-radius: 10px;
    width: min(420px, 92vw); padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.08);
    font-family: system-ui, sans-serif;
  }
  #authCard input { width: 100%; padding: 10px; border:1px solid #ddd; border-radius: 8px; }
  #authRow { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:10px; }
  #rememberRow { display:flex; align-items:center; gap:8px; margin-top:8px; }
  #authBtn { background:#2ecc71; color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; }
  #authError { color:#e74c3c; font-size:.9rem; display:none; margin-top:8px; }
</style>
</head>
<body>

<div id="authGate">
  <div id="authCard">
    <h2>üîí Zugang</h2>
    <p>Bitte Passwort eingeben, um die Liste zu √∂ffnen.</p>
    <input id="pwInput" type="password" placeholder="Passwort" autocomplete="current-password" />
    <div id="rememberRow">
      <label><input id="rememberDevice" type="checkbox"> auf diesem Ger√§t merken</label>
    </div>
    <div id="authRow">
      <button id="authBtn">Entsperren</button>
    </div>
    <div id="authError">Falsches Passwort.</div>
  </div>
</div>

<header>Shared Shopping</header>

<main>
  <div class="input-row">
    <input id="qtyInput" placeholder="Menge" />
    <input id="itemInput" placeholder="Artikel" />
    <button id="addBtn" class="btn btn-add">+</button>
  </div>

  <ul id="list"></ul>

  <div class="bulk-bar">
    <div class="bulk-left">
      <button id="toggleAllBtn" class="btn-secondary">Alle ausw√§hlen</button>
      <span id="selectionHint" class="hint">0 ausgew√§hlt</span>
    </div>
    <div class="bulk-right">
      <button id="undoBtn" class="btn-secondary" style="display:none;">‚Ü© R√ºckg√§ngig</button>
      <button id="deleteSelectedBtn" class="btn-del btn-muted" disabled>Ausgew√§hlte l√∂schen</button>
    </div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBapD5LES4TOhhHjgX3664a7DnxC2043JU",
    authDomain: "shoppinglist-66fa7.firebaseapp.com",
    projectId: "shoppinglist-66fa7",
    storageBucket: "shoppinglist-66fa7.firebasestorage.app",
    messagingSenderId: "531815588287",
    appId: "1:531815588287:web:28e9cac4f6de909361c10a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const listEl = document.getElementById("list");
  const addBtn = document.getElementById("addBtn");
  const qtyInput = document.getElementById("qtyInput");
  const itemInput = document.getElementById("itemInput");
  const toggleAllBtn = document.getElementById("toggleAllBtn");
  const selectionHint = document.getElementById("selectionHint");
  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  const undoBtn = document.getElementById("undoBtn");

  let selectedIds = new Set();
  let lastDeleted = [];

  onSnapshot(collection(db, "items"), (snapshot) => {
    listEl.innerHTML = "";
    snapshot.forEach(docSnap => {
      const item = docSnap.data();
      const li = document.createElement("li");

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = selectedIds.has(docSnap.id);
      checkbox.onchange = () => {
        if (checkbox.checked) selectedIds.add(docSnap.id);
        else selectedIds.delete(docSnap.id);
        updateSelectionUI();
      };

      const textDiv = document.createElement("div");
      textDiv.className = "item-text";
      textDiv.innerHTML = `<strong>${item.qty || ""}</strong> ${item.name || ""}`;

      const delBtn = document.createElement("button");
      delBtn.textContent = "üóë";
      delBtn.className = "btn btn-del";
      delBtn.onclick = async () => {
        await deleteDoc(doc(db, "items", docSnap.id));
      };

      li.appendChild(checkbox);
      li.appendChild(textDiv);
      li.appendChild(delBtn);

      listEl.appendChild(li);
    });
    updateSelectionUI();
  });

  addBtn.onclick = async () => {
    const qty = qtyInput.value.trim();
    const name = itemInput.value.trim();
    if (!name) return;
    await addDoc(collection(db, "items"), { qty, name });
    qtyInput.value = "";
    itemInput.value = "";
  };

  function updateSelectionUI() {
    const count = selectedIds.size;
    selectionHint.textContent = `${count} ausgew√§hlt`;
    deleteSelectedBtn.disabled = count === 0;
  }

  toggleAllBtn.onclick = async () => {
    const snap = await (await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"))
      .getDocs(collection(db, "items"));
    let total = 0, checked = 0;
    snap.forEach(d => { total++; if (selectedIds.has(d.id)) checked++; });
    const selectAll = checked !== total;
    snap.forEach(d => {
      if (selectAll) selectedIds.add(d.id);
      else selectedIds.delete(d.id);
    });
    document.querySelectorAll("#list input[type=checkbox]").forEach(cb => {
      cb.checked = selectAll;
    });
    updateSelectionUI();
  };

  deleteSelectedBtn.onclick = async () => {
    lastDeleted = [];
    for (let id of selectedIds) {
      lastDeleted.push(id);
      await deleteDoc(doc(db, "items", id));
    }
    selectedIds.clear();
    updateSelectionUI();
    undoBtn.style.display = "inline-block";
  };

  undoBtn.onclick = async () => {
    // Hier k√∂nntest du "lastDeleted" wiederherstellen, wenn du die Daten speicherst
    undoBtn.style.display = "none";
  };

  // Passwortschutz
  const PASSWORD_SHA256_HEX = "0b14d501a594442a01c6859541bcb3e8164d183d32937b851835442f69d5c94e"; // "pepper"
  async function sha256Hex(str) {
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
  }
  const gate = document.getElementById("authGate");
  const btn = document.getElementById("authBtn");
  const inp = document.getElementById("pwInput");
  const err = document.getElementById("authError");
  const remember = document.getElementById("rememberDevice");
  if (localStorage.getItem("sharedShoppingUnlocked") === "yes") gate.style.display = "none";
  btn.onclick = async () => {
    err.style.display = "none";
    const hash = await sha256Hex(inp.value || "");
    if (hash === PASSWORD_SHA256_HEX) {
      if (remember.checked) localStorage.setItem("sharedShoppingUnlocked", "yes");
      gate.style.display = "none";
    } else {
      err.style.display = "block";
      inp.select();
    }
  };
  inp.addEventListener("keydown", e => { if (e.key === "Enter") btn.click(); });
</script>
</body>
</html>
